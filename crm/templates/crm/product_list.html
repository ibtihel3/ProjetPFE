{% extends 'base.html' %}
{% block content %}
<h2>üì¶ Products</h2>
<a href="{% url 'product_add' %}">‚ûï Add Product</a>


<!-- üñºÔ∏è Search by Image -->
<form action="{% url 'similar_from_image' %}" method="POST" enctype="multipart/form-data" class="d-flex align-items-center gap-2 mb-0" style="flex: 1; max-width: 350px;">
      {% csrf_token %}
      <input type="file" name="image" accept="image/*" class="form-control" required style="height:45px;">
      <button type="submit" class="btn btn-outline-primary" style="height:45px; white-space:nowrap;">
        üñºÔ∏è Find Similar
      </button>
</form>

<!-- üîç Search by Text -->
<div class="position-relative d-flex align-items-center" style="flex: 1; max-width: 450px;">
      <input
        type="text"
        id="productSearch"
        class="form-control"
        placeholder="Search for products..."
        autocomplete="off"
        style="height:45px;"
      />
      <div
        id="searchResults"
        class="position-absolute bg-white border rounded shadow-lg mt-1 w-100"
        style="display:none; z-index:2000; max-height:400px; overflow-y:auto;"
      ></div>
</div>

<br><br>
<div style="max-height:500px; overflow:auto; border:1px solid #ccc; border-radius:8px;">
  <table border="1" cellpadding="8" style="width:100%; border-collapse:collapse; min-width:1200px;">
   <tr style="background:#4CAF50; color:white;">
    <th>Name</th>
    <th>Category</th>
    <th>Similar Products</th>
    <th>Predicted Discount (%)</th>
    <th>Discounted (‚Ç¨)</th>
    <th>Compare in Market</th>
    <th>Actual (‚Ç¨)</th>
    <th>Rating</th>
    <th>Rating Count</th>
    <th>About Product</th>
    <th>Stock</th>
    <th>Creation Date</th>
    <th>Last Updated</th>
    <th>Status</th>
    <th>Actions</th>
  </tr>

  {% for p in page_obj %}
   <tr>
       <!-- Name Pagination -->
    <td>
      {% if p.product_name %}
        {% with p.product_name.split as words %}
          {% if words|length > 3 %}
            {{ words|slice:":3"|join:" " }}...
            <a href="#" onclick="openModal('{{ p.id1 }}'); return false;">Read more</a>
            <!-- Modal -->
            <div id="modal-{{ p.id1 }}" class="modal">
              <div class="modal-content">
                <h3>{{ p.product_name }}</h3>
              </div>
            </div>
          {% else %}
            {{ p.product_name }}
          {% endif %}
        {% endwith %}
      {% else %}
        -
      {% endif %}
    </td>
    <td>{{ p.category }}</td>
    <td>
      <a href="{% url 'similar_products' p.id %}">üîç Similar</a>
    </td>
    <td style="color:green;">
      {% if p.discount_percentage %}
        {{ p.discount_percentage}}
      {% else %}
        <a href="{% url 'predict_for_product' p.id %}">üîÆ Predict</a>
      {% endif %}
    </td>
    <td>
        <a href="{% url 'compare_price_page' p.id %}"
     class="btn btn-sm btn-outline-success"
     style="margin-left:4px; font-size:13px; padding:3px 8px; border-radius:6px;">
     üí∞ Compare
  </a>
  {% if p.compare_price %}
    <br><small style="color:#007bff;">Market: {{ p.compare_price }} {{ p.compare_currency|default:"‚Ç¨" }}</small>
  {% endif %}
    </td>
    <td>{{ p.discounted_price}}</td>
    <td>{{ p.actual_price|floatformat:2 }}</td>
    <td>{{ p.rating|default:"-" }}</td>
    <td>{{ p.rating_count }}</td>

    <!-- About Product truncated -->
    <td>
      {% if p.about_product %}
        {% with p.about_product.split as words %}
          {% if words|length > 3 %}
            {{ words|slice:":3"|join:" " }}...
            <a href="#" onclick="openModal('{{ p.id }}'); return false;">Read more</a>

            <!-- Modal -->
            <div id="modal-{{ p.id }}" class="modal">
              <div class="modal-content">
                <span class="close" onclick="closeModal('{{ p.id }}')">&times;</span>
                <h3>{{ p.product_name }}</h3>
                <p>{{ p.about_product }}</p>
              </div>
            </div>
          {% else %}
            {{ p.about_product }}
          {% endif %}
        {% endwith %}
      {% else %}
        -
      {% endif %}
    </td>

    <td>{{ p.stock }}</td>
    <td>{{ p.creation_date }}</td>
    <td>{{ p.last_updated_date }}</td>
    <td>{{ p.status }}</td>
<td>
  <a href="{% url 'product_edit' p.id %}">‚úèÔ∏è Edit</a> |
  <a href="{% url 'product_delete' p.id %}">üóëÔ∏è Delete</a> |
</td>

  </tr>
   {% empty %}
   <tr><td colspan="13" style="text-align:center;">No products found.</td></tr>
   {% endfor %}
  </table>

<!-- Pagination Controls -->
<div style="margin-top:20px; text-align:center;">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}">‚¨ÖÔ∏è Previous</a>
  {% endif %}

  <span> Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }} </span>

  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}">Next ‚û°Ô∏è</a>
  {% endif %}
</div>

<!-- ===== Modal Styling & Script ===== -->
<style>
.hover-bg-light:hover {
  background-color: #f8f9fa;
  cursor: pointer;
}
.modal {
  display: none;
  position: fixed;
  z-index: 10;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.5);
}
.modal-content {
  background-color: #fff;
  margin: 10% auto;
  padding: 20px;
  border-radius: 10px;
  width: 60%;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.close {
  float: right;
  font-size: 24px;
  cursor: pointer;
}
</style>

<script>
function openModal(id) {
  document.getElementById("modal-" + id).style.display = "block";
}
function closeModal(id) {
  document.getElementById("modal-" + id).style.display = "none";
}
// Close modal when clicking outside
window.onclick = function(event) {
  document.querySelectorAll('.modal').forEach(modal => {
    if (event.target === modal) {
      modal.style.display = "none";
    }
  });
}
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById("productSearch");
  const table = document.querySelector("table");
  const resultsBox = document.getElementById("searchResults");
  let timeout = null;

  searchInput.addEventListener("input", () => {
    clearTimeout(timeout);
    const query = searchInput.value.trim();
    resultsBox.style.display = "none"; // hide old dropdown
    timeout = setTimeout(() => fetchProducts(query), 300);
  });

  async function fetchProducts(query) {
    try {
      // Remove all old rows except the header
      const rows = table.querySelectorAll("tr:not(:first-child)");
      rows.forEach(r => r.remove());

      // Show loading row
      const loadingRow = document.createElement("tr");
      loadingRow.innerHTML = `<td colspan="15" style="text-align:center;">‚è≥ Searching...</td>`;
      table.appendChild(loadingRow);

      const response = await fetch(`/ajax/search-products/?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      const products = data.results || [];

      // Remove loading row
      loadingRow.remove();

      if (products.length > 0) {
        products.forEach(p => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>
              ${p.name && p.name.split(' ').length > 3
                ? `${p.name.split(' ').slice(0,3).join(' ')}...
                   <a href="#" onclick="openModal('name-${p.id}');return false;">Read more</a>
                   <div id="modal-name-${p.id}" class="modal">
                     <div class="modal-content">
                       <span class="close" onclick="closeModal('name-${p.id}')">&times;</span>
                       <h3>${p.name}</h3>
                     </div>
                   </div>`
                : (p.name || '-')}
            </td>

            <td>${p.category || '-'}</td>
            <td><a href="/products/${p.id}/similar/">üîç Similar</a></td>

            <td style="color:green;">
              ${p.discount_percentage
                ? p.discount_percentage
                : `<a href="/products/${p.id}/predict_for_product/">üîÆ Predict</a>`}
            </td>

            <td>${p.discounted_price || '-'}</td>

            <td>
              <a href="/products/${p.id}/compare/" class="btn btn-sm btn-outline-success"
                 style="margin-left:4px; font-size:13px; padding:3px 8px; border-radius:6px;">
                 üí∞ Compare
              </a>
              ${p.compare_price ? `<br><small style="color:#007bff;">Market: ${p.compare_price} ‚Ç¨</small>` : ''}
            </td>

            <td>${p.actual_price || '-'}</td>
            <td>${p.rating || '-'}</td>
            <td>${p.rating_count || '-'}</td>

            <td>
              ${p.about && p.about.split(' ').length > 3
                ? `${p.about.split(' ').slice(0,3).join(' ')}...
                   <a href="#" onclick="openModal('about-${p.id}');return false;">Read more</a>
                   <div id="modal-about-${p.id}" class="modal">
                     <div class="modal-content">
                       <span class="close" onclick="closeModal('about-${p.id}')">&times;</span>
                       <h3>${p.name}</h3>
                       <p>${p.about}</p>
                     </div>
                   </div>`
                : (p.about || '-')}
            </td>

            <td>${p.stock || '-'}</td>
            <td>${p.creation_date || '-'}</td>
            <td>${p.last_updated_date || '-'}</td>
            <td>${p.status || '-'}</td>

            <td>
              <a href="/products/${p.id}/edit/">‚úèÔ∏è Edit</a> |
              <a href="/products/${p.id}/delete/">üóëÔ∏è Delete</a> |
            </td>
          `;
          table.appendChild(row);
        });
      } else {
        const emptyRow = document.createElement("tr");
        emptyRow.innerHTML = `<td colspan="15" style="text-align:center;">No products found.</td>`;
        table.appendChild(emptyRow);
      }
    } catch (error) {
      console.error("‚ö†Ô∏è Error fetching products:", error);
      const errorRow = document.createElement("tr");
      errorRow.innerHTML = `<td colspan="15" style="text-align:center;color:red;">Error loading products.</td>`;
      table.appendChild(errorRow);
    }
  }
});
</script>




{% endblock %}