{% extends 'base.html' %}
{% block content %}
<style>
/* ===== Dashboard Styling ===== */
body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; background-color: #f7f9fc; }
.dashboard-container { width: 92%; margin: 30px auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 26px 34px; }
h2 { color: #2b3a67; margin-bottom: 16px; border-left: 6px solid #4CAF50; padding-left: 12px; }
.filters { display: grid; grid-template-columns: repeat(6, minmax(140px, 1fr)); gap: 12px; margin: 12px 0 22px 0; }
.filters input, .filters select { padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; }
.filters .actions { display: flex; gap: 10px; align-items: center; }
.btn { background:#4CAF50; color:white; padding: 8px 14px; border-radius: 8px; text-decoration:none; border:none; cursor:pointer; }
.btn.secondary { background:#e9eef5; color:#2b3a67; }
.card-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin: 10px 0 24px 0; }
.card { background:#fafafa; border-radius: 10px; padding: 16px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
.card h3 { color: #444; margin-bottom: 8px; font-size: 0.95rem; }
.card p { font-size: 1.35rem; font-weight: bold; color: #333; margin: 0; }
.section-title { color: #2b3a67; margin-top: 18px; margin-bottom: 8px; }
.chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 16px; }
.chart-box { background: #fff; border: 1px solid #eef2f8; border-radius: 12px; padding: 14px; }
.table-wrapper { overflow-x: auto; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #e9e9e9; vertical-align: top; }
th { background: #4CAF50; color: white; }
tr:hover td { background-color: #f4f9f4; }
.sentiment-positive { color: #4CAF50; font-weight: bold; }
.sentiment-neutral { color: #FFC107; font-weight: bold; }
.sentiment-negative { color: #F44336; font-weight: bold; }
.pagination { margin-top: 12px; text-align: center; display:flex; gap:10px; justify-content:center; }
@media (max-width: 1100px) { .filters { grid-template-columns: repeat(2, 1fr); } .chart-row { grid-template-columns: 1fr; } .card-container { grid-template-columns: repeat(2, 1fr); } }
</style>

<div class="dashboard-container">
  <h2>üß† Product Review Sentiment Dashboard</h2>

  {% if no_data %}
    <p style="text-align:center; font-size:1.1rem; color:#888;">No reviews found for the current filters.</p>
  {% else %}

  <!-- Filters -->
  <form method="get" class="filters">
    <select name="category">
      <option value="all">All categories</option>
      {% for c in categories %}
        <option value="{{ c }}" {% if selected_category == c %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>

    <select name="status">
      <option value="all">All status</option>
      {% for s in statuses %}
        <option value="{{ s }}" {% if selected_status == s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>

    <input type="number" step="0.1" name="min_rating" placeholder="Min rating"
           value="{{ selected_min_rating }}">

    <input type="date" name="date_from" value="{{ selected_date_from }}">
    <input type="date" name="date_to" value="{{ selected_date_to }}">

    <div class="actions">
      <button class="btn" type="submit">Apply Filters</button>
      <a class="btn secondary" href="{% url 'reviews_dashboard' %}">Reset</a>
      <a class="btn" href="{% url 'reviews_export' %}">Export CSV</a>
    </div>
  </form>

  <!-- KPI Cards -->
<div class="card-container" style="
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  gap: 1.2rem;
  margin: 1.5rem 0;
  width: 100%;
">

  <div class="card" style="
    flex: 1 1 220px;
    min-width: 220px;
    max-width: 280px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 1rem 1.2rem;
    text-align: center;
  ">
    <h3 style="font-size:1.1rem; color:#2b3a67;">Total Reviews Analyzed</h3>
    <p style="font-size:1.3rem; font-weight:600; color:#4CAF50; margin-top:0.5rem;">{{ total_reviews }}</p>
  </div>

  <div class="card" style="
    flex: 1 1 220px;
    min-width: 220px;
    max-width: 280px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 1rem 1.2rem;
    text-align: center;
  ">
    <h3 style="font-size:1.1rem; color:#2b3a67;">Average Sentiment</h3>
    <p style="font-size:1.3rem; font-weight:600; color:#2196F3; margin-top:0.5rem;">
      {{ avg_sentiment|floatformat:3 }}
    </p>
  </div>

  <div class="card" style="
    flex: 1 1 300px;
    min-width: 300px;
    max-width: 380px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 1rem 1.2rem;
  ">
    <h3 style="font-size:1.1rem; color:#2b3a67;">Top Positive</h3>
    <p style="font-size:0.95rem; color:#2b3a67; line-height:1.4; max-height:150px; overflow-y:auto;">
      {% for t in top_positive %}
        ‚úÖ {{ t.product_name }} ({{ t.category }}) ‚Äî {{ t.sentiment|floatformat:2 }}<br>
      {% empty %}‚Äî{% endfor %}
    </p>
  </div>

  <div class="card" style="
    flex: 1 1 300px;
    min-width: 300px;
    max-width: 380px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 1rem 1.2rem;
  ">
    <h3 style="font-size:1.1rem; color:#2b3a67;">Top Negative</h3>
    <p style="font-size:0.95rem; color:#2b3a67; line-height:1.4; max-height:150px; overflow-y:auto;">
      {% for t in top_negative %}
        ‚ö†Ô∏è {{ t.product_name }} ({{ t.category }}) ‚Äî {{ t.sentiment|floatformat:2 }}<br>
      {% empty %}‚Äî{% endfor %}
    </p>
  </div>

</div>


  <!-- Charts -->
  <div class="chart-row">
    <div class="chart-box">
      <h3 class="section-title">Sentiment Distribution</h3>
      <canvas id="sentimentChart" height="220"></canvas>
    </div>
    <div class="chart-box">
      <h3 class="section-title">Average Sentiment by Category</h3>
      <canvas id="categoryChart" height="220"></canvas>
    </div>
  </div>
  {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const sentimentData = JSON.parse('{{ sentiment_counts|escapejs }}');
const catData = JSON.parse('{{ category_sentiment|escapejs }}');

// Pie/Doughnut ‚Äì Sentiment Distribution
new Chart(document.getElementById('sentimentChart'), {
  type: 'doughnut',
  data: {
    labels: Object.keys(sentimentData),
    datasets: [{
      data: Object.values(sentimentData),
      backgroundColor: ['#4CAF50', '#FFC107', '#F44336'],
      borderWidth: 1
    }]
  },
  options: { plugins: { legend: { position: 'bottom' } } }
});

// === Bar ‚Äì Average Sentiment by Category (Hover Only) ===
const categories = catData.map(c => c.category);
const sentiments = catData.map(c => c.sentiment);

new Chart(document.getElementById('categoryChart'), {
  type: 'bar',
  data: {
    labels: categories,
    datasets: [{
      label: 'Avg Sentiment',
      data: sentiments,
      backgroundColor: sentiments.map(v =>
        v > 0.1 ? '#4CAF50' : v < -0.1 ? '#F44336' : '#FFC107'
      ),
      borderRadius: 6
    }]
  },
  options: {
    scales: {
      x: {
        display: false  // üëà hide category names
      },
      y: {
        display: false, // üëà hide sentiment axis values
        beginAtZero: true,
        min: -1,
        max: 1
      }
    },
    plugins: {
      legend: { display: false }, // üëà hide legend
      tooltip: {
        enabled: true,
        backgroundColor: 'rgba(255,255,255,0.95)',
        titleColor: '#333',
        bodyColor: '#333',
        titleFont: { size: 13, weight: 'bold' },
        bodyFont: { size: 12 },
        callbacks: {
          title: ctx => ctx[0].label,
          label: ctx => `Average Sentiment: ${ctx.parsed.y.toFixed(2)}`
        },
        displayColors: false
      },
      datalabels: { display: false } // üëà no text on bars
    },
    layout: {
      padding: 10
    }
  }
});

</script>
{% endblock %}
