{% extends 'base.html' %}
{% block content %}

<h2>ðŸ’¬ CRM Chatbot</h2>
<p style="color:#555;">Ask me anything about your products or clients.</p>

<div id="chat-container" style="
  width: 80%;
  margin: 0 auto;
  background: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
">

  <!-- Chat Display -->
  <div id="chatbox" style="
    height: 450px;
    overflow-y: auto;
    padding: 10px;
    background: white;
    border-radius: 6px;
    border: 1px solid #ccc;
  ">
    <div id="welcome" style="color:gray;">
      <p><b>ðŸ¦‰ BoWiseBot:</b> Hello {{ request.user.username }}, Iâ€™m your AI assistant! Ask me about your products or clients anytime.</p>
    </div>
  </div>

  <!-- Input Form -->
  <form id="chat-form" method="POST" style="margin-top: 10px; display: flex; gap: 10px;">
    {% csrf_token %}
    <input type="text" id="user-input" name="message"
      placeholder="Type your question and I'll assist you! "
      style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 15px;">
    <button type="submit" style="
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    ">Send</button>
  </form>
</div>

<!-- Chat Styles -->
<style>
  .user-msg { color: #000; background: #e7ffe7; padding: 8px; border-radius: 8px; margin-bottom: 6px; width: fit-content; max-width: 80%; }
  .bot-msg { color: #000; background: #eef1ff; padding: 8px; border-radius: 8px; margin-bottom: 6px; width: fit-content; max-width: 80%; }
</style>

<!-- JS Logic -->
<script>
document.getElementById('chat-form').onsubmit = async function(e) {
  e.preventDefault();

  const input = document.getElementById('user-input');
  const chatbox = document.getElementById('chatbox');
  const message = input.value.trim();

  if (!message) return;

  // Show user message
  chatbox.innerHTML += `<div class='user-msg'><b>You:</b> ${message}</div>`;
  input.value = "";

  // Auto-scroll
  chatbox.scrollTop = chatbox.scrollHeight;

  // Send to backend
  const response = await fetch("{% url 'chatbot' %}", {
    method: "POST",
    headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value },
    body: new URLSearchParams({ message })
  });

  const data = await response.json();
  const botResponse = data.response.replace(/\n/g, "<br>");

  chatbox.innerHTML += `<div class='bot-msg'><b>Bot:</b> ${botResponse}</div>`;
  chatbox.scrollTop = chatbox.scrollHeight;
};

window.addEventListener("DOMContentLoaded", () => {
  const chatContainer = document.getElementById("chatbox");
  const chatHistory = JSON.parse(localStorage.getItem("bowise_chat") || "[]");
  chatHistory.forEach(msg => {
    chatContainer.innerHTML += `<div><b>${msg.sender}:</b> ${msg.message}</div>`;
  });
});

function resetChat() {
  localStorage.removeItem("bowise_chat");
  const chatBody = document.getElementById("chatbox");
  chatBody.innerHTML = "<div style='color:#888;'>ðŸ’¬ Chat reset. How can I help you?</div>";
}
</script>

{% endblock %}
